"use strict";var e=require("@avalabs/avalanchejs"),t=require("viem");function n(e){return function(e,{strict:t=!0}={}){return!!e&&"string"==typeof e&&(t?/^0x[0-9a-fA-F]*$/.test(e):e.startsWith("0x"))}(e,{strict:!1})?Math.ceil((e.length-2)/2):e.length}const r="2.38.6";let s=({docsBaseUrl:e,docsPath:t="",docsSlug:n})=>t?`${e??"https://viem.sh"}${t}${n?`#${n}`:""}`:void 0,i=`viem@${r}`;class a extends Error{constructor(e,t={}){const n=t.cause instanceof a?t.cause.details:t.cause?.message?t.cause.message:t.details,o=t.cause instanceof a&&t.cause.docsPath||t.docsPath,c=s?.({...t,docsPath:o});super([e||"An error occurred.","",...t.metaMessages?[...t.metaMessages,""]:[],...c?[`Docs: ${c}`]:[],...n?[`Details: ${n}`]:[],...i?[`Version: ${i}`]:[]].join("\n"),t.cause?{cause:t.cause}:void 0),Object.defineProperty(this,"details",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"docsPath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metaMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shortMessage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"BaseError"}),this.details=n,this.docsPath=o,this.metaMessages=t.metaMessages,this.name=t.name??this.name,this.shortMessage=e,this.version=r}walk(e){return o(this,e)}}function o(e,t){return t?.(e)?e:e&&"object"==typeof e&&"cause"in e&&void 0!==e.cause?o(e.cause,t):t?null:e}class c extends a{constructor({size:e,targetSize:t,type:n}){super(`${n.charAt(0).toUpperCase()}${n.slice(1).toLowerCase()} size (${e}) exceeds padding size (${t}).`,{name:"SizeExceedsPaddingSizeError"})}}function u(e,{dir:t,size:n=32}={}){return"string"==typeof e?function(e,{dir:t,size:n=32}={}){if(null===n)return e;const r=e.replace("0x","");if(r.length>2*n)throw new c({size:Math.ceil(r.length/2),targetSize:n,type:"hex"});return`0x${r["right"===t?"padEnd":"padStart"](2*n,"0")}`}(e,{dir:t,size:n}):function(e,{dir:t,size:n=32}={}){if(null===n)return e;if(e.length>n)throw new c({size:e.length,targetSize:n,type:"bytes"});const r=new Uint8Array(n);for(let s=0;s<n;s++){const i="right"===t;r[i?s:n-s-1]=e[i?s:e.length-s-1]}return r}(e,{dir:t,size:n})}class l extends a{constructor({max:e,min:t,signed:n,size:r,value:s}){super(`Number "${s}" is not in safe ${r?`${8*r}-bit ${n?"signed":"unsigned"} `:""}integer range ${e?`(${t} to ${e})`:`(above ${t})`}`,{name:"IntegerOutOfRangeError"})}}class d extends a{constructor({givenSize:e,maxSize:t}){super(`Size cannot exceed ${t} bytes. Given size: ${e} bytes.`,{name:"SizeOverflowError"})}}function f(e,{size:t}){if(n(e)>t)throw new d({givenSize:n(e),maxSize:t})}function h(e,t={}){return Number(function(e,t={}){const{signed:n}=t;t.size&&f(e,{size:t.size});const r=BigInt(e);if(!n)return r;const s=(e.length-2)/2;return r<=(1n<<8n*BigInt(s)-1n)-1n?r:r-BigInt(`0x${"f".padStart(2*s,"f")}`)-1n}(e,t))}function p(e,t={}){const{signed:n,size:r}=t,s=BigInt(e);let i;r?i=n?(1n<<8n*BigInt(r)-1n)-1n:2n**(8n*BigInt(r))-1n:"number"==typeof e&&(i=BigInt(Number.MAX_SAFE_INTEGER));const a="bigint"==typeof i&&n?-i-1n:0;if(i&&s>i||s<a){const t="bigint"==typeof e?"n":"";throw new l({max:i?`${i}${t}`:void 0,min:`${a}${t}`,signed:n,size:r,value:`${e}${t}`})}const o=`0x${(n&&s<0?(1n<<BigInt(8*r))+BigInt(s):s).toString(16)}`;return r?u(o,{size:r}):o}function g(e){return"string"==typeof e?{address:e,type:"json-rpc"}:e}async function m(e,{address:t,blockTag:n="latest",blockNumber:r}){return h(await e.request({method:"eth_getTransactionCount",params:[t,"bigint"==typeof r?p(r):n]},{dedupe:Boolean(r)}))}async function x(e){return e.request({method:"eth_baseFee",params:[]})}async function b(e,t){return e.request({method:"info.getBlockchainID",params:t})}t.parseAbiItem("event SendWarpMessage(address indexed sourceAddress, bytes32 indexed unsignedMessageID, bytes message)"),new e.Id(new Uint8Array(32)),new e.Id(new Uint8Array(32));const y=1,w=2,v=3,I=4,B=5,$=10,z=12345,A={[y]:"avax",[w]:"cascade",[v]:"denali",[I]:"everest",[B]:"fuji",[$]:"testing",[z]:"local"},C=e=>A[e]??"custom",P=async(e,t="AVAX")=>{const{assetID:n}=await async function(e,t){return e.request({method:"avm.getAssetDescription",params:t})}(e.xChainClient,{assetID:t}),{txFee:r,createAssetTxFee:s}=await async function(e){return e.request({method:"avm.getTxFee",params:{}})}(e.xChainClient),{blockchainID:i}=await b(e.infoClient,{alias:"X"}),{blockchainID:a}=await b(e.infoClient,{alias:"P"}),{blockchainID:o}=await b(e.infoClient,{alias:"C"}),{networkID:c}=await async function(e){return e.request({method:"info.getNetworkID",params:{}})}(e.infoClient),u=Number(c),l=await async function(e){const t=await e.request({method:"platform.getFeeConfig",params:{}});return{...t,maxCapacity:BigInt(t.maxCapacity),maxPerSecond:BigInt(t.maxPerSecond),minPrice:BigInt(t.minPrice),targetPerSecond:BigInt(t.targetPerSecond),excessConversionConstant:BigInt(t.excessConversionConstant)}}(e.pChainClient);return Object.freeze({xBlockchainID:i,pBlockchainID:a,cBlockchainID:o,avaxAssetID:n,baseTxFee:BigInt(r),createAssetTxFee:BigInt(s),networkID:u,hrp:C(u),platformFeeConfig:l})},k=2n**256n,S=k-0x1000003d1n,E=k-0x14551231950b75fc4402da1732fc9bebfn,T={a:0n,b:7n},D=e=>V(V(e*e)*e+T.b),N=(e="")=>{throw new Error(e)},M=e=>"bigint"==typeof e,j=e=>"string"==typeof e,q=e=>M(e)&&0n<e&&e<S,U=e=>M(e)&&0n<e&&e<E,O=e=>new Uint8Array(e),F=(e,t)=>((e,t)=>!(e instanceof Uint8Array)||"number"==typeof t&&t>0&&e.length!==t?N("Uint8Array expected"):e)(j(e)?W(e):O(e),t),V=(e,t=S)=>{let n=e%t;return n>=0n?n:t+n},R=e=>e instanceof K?e:N("Point expected");let H;class K{constructor(e,t,n){this.px=e,this.py=t,this.pz=n}static fromAffine(e){return new K(e.x,e.y,1n)}static fromHex(e){let t;const n=(e=F(e))[0],r=e.subarray(1),s=L(r,0,32),i=e.length;if(33===i&&[2,3].includes(n)){q(s)||N("Point hex invalid: x not FE");let e=ee(D(s));!(1&~n)!==(1n==(1n&e))&&(e=V(-e)),t=new K(s,e,1n)}return 65===i&&4===n&&(t=new K(s,L(r,32,64),1n)),t?t.ok():N("Point is not on curve")}static fromPrivateKey(e){return J.mul(te(e))}get x(){return this.aff().x}get y(){return this.aff().y}equals(e){const{px:t,py:n,pz:r}=this,{px:s,py:i,pz:a}=R(e),o=V(t*a),c=V(s*r),u=V(n*a),l=V(i*r);return o===c&&u===l}negate(){return new K(this.px,V(-this.py),this.pz)}double(){return this.add(this)}add(e){const{px:t,py:n,pz:r}=this,{px:s,py:i,pz:a}=R(e),{a:o,b:c}=T;let u=0n,l=0n,d=0n;const f=V(3n*c);let h=V(t*s),p=V(n*i),g=V(r*a),m=V(t+n),x=V(s+i);m=V(m*x),x=V(h+p),m=V(m-x),x=V(t+r);let b=V(s+a);return x=V(x*b),b=V(h+g),x=V(x-b),b=V(n+r),u=V(i+a),b=V(b*u),u=V(p+g),b=V(b-u),d=V(o*x),u=V(f*g),d=V(u+d),u=V(p-d),d=V(p+d),l=V(u*d),p=V(h+h),p=V(p+h),g=V(o*g),x=V(f*x),p=V(p+g),g=V(h-g),g=V(o*g),x=V(x+g),h=V(p*x),l=V(l+h),h=V(b*x),u=V(m*u),u=V(u-h),h=V(m*p),d=V(b*d),d=V(d+h),new K(u,l,d)}mul(e,t=!0){if(!t&&0n===e)return Q;if(U(e)||N("invalid scalar"),this.equals(J))return ne(e).p;let n=Q,r=J;for(let s=this;e>0n;s=s.double(),e>>=1n)1n&e?n=n.add(s):t&&(r=r.add(s));return n}mulAddQUns(e,t,n){return this.mul(t,!1).add(e.mul(n,!1)).ok()}toAffine(){const{px:e,py:t,pz:n}=this;if(this.equals(Q))return{x:0n,y:0n};if(1n===n)return{x:e,y:t};const r=G(n);return 1n!==V(n*r)&&N("invalid inverse"),{x:V(e*r),y:V(t*r)}}assertValidity(){const{x:e,y:t}=this.aff();return q(e)&&q(t)||N("Point invalid: x or y"),V(t*t)===D(e)?this:N("Point invalid: not on curve")}multiply(e){return this.mul(e)}aff(){return this.toAffine()}ok(){return this.assertValidity()}toHex(e=!0){const{x:t,y:n}=this.aff();return(e?0n==(1n&n)?"02":"03":"04")+Z(t)+(e?"":Z(n))}toRawBytes(e=!0){return W(this.toHex(e))}}K.BASE=new K(0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798n,0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8n,1n),K.ZERO=new K(0n,1n,0n);const{BASE:J,ZERO:Q}=K,X=(e,t)=>e.toString(16).padStart(t,"0"),Y=e=>Array.from(e).map(e=>X(e,2)).join(""),W=e=>{const t=e.length;(!j(e)||t%2)&&N("hex invalid 1");const n=O(t/2);for(let t=0;t<n.length;t++){const r=2*t,s=e.slice(r,r+2),i=Number.parseInt(s,16);(Number.isNaN(i)||i<0)&&N("hex invalid 2"),n[t]=i}return n},_=e=>BigInt("0x"+(Y(e)||"0")),L=(e,t,n)=>_(e.slice(t,n)),Z=e=>Y((e=>M(e)&&e>=0n&&e<k?W(X(e,64)):N("bigint expected"))(e)),G=(e,t=S)=>{(0n===e||t<=0n)&&N("no inverse n="+e+" mod="+t);let n=V(e,t),r=t,s=0n,i=1n;for(;0n!==n;){const e=r%n,t=s-i*(r/n);r=n,n=e,s=i,i=t}return 1n===r?V(s,t):N("no inverse")},ee=e=>{let t=1n;for(let n=e,r=(S+1n)/4n;r>0n;r>>=1n)1n&r&&(t=t*n%S),n=n*n%S;return V(t*t)===e?t:N("sqrt invalid")},te=e=>(M(e)||(e=_(F(e,32))),U(e)?e:N("private key out of range")),ne=e=>{const t=H||(H=(()=>{const e=[];let t=J,n=t;for(let r=0;r<33;r++){n=t,e.push(n);for(let r=1;r<128;r++)n=n.add(t),e.push(n);t=n.double()}return e})()),n=(e,t)=>{let n=t.negate();return e?n:t};let r=Q,s=J;const i=BigInt(255),a=BigInt(8);for(let o=0;o<33;o++){const c=128*o;let u=Number(e&i);e>>=a,u>128&&(u-=256,e+=1n);const l=c,d=c+Math.abs(u)-1,f=o%2!=0,h=u<0;0===u?s=s.add(n(f,t[l])):r=r.add(n(h,t[d]))}return{p:r,f:s}};function re(t,n){const r=K.fromHex(e.utils.strip0x(t)),s=new Uint8Array(r.toRawBytes(!0)),i=e.secp256k1.publicKeyBytesToAddress(s);return e.utils.formatBech32(n,i)}function se(e){return"string"==typeof e?{evmAccount:g(e)}:e}function ie(t,n){let r;r="string"==typeof t?e.utils.hexToBuffer(t):t;return e.utils.getManagerForVM("EVM").unpack(r,e.Utxo)}const ae="C";function oe(t){return t.includes("-")?e.utils.bech32ToBytes(t):e.utils.bech32ToBytes(`P-${t}`)}function ce(e){return e/BigInt(1e9)}function ue(e,t){if(1!==t&&5!==t)throw new Error(`Invalid network ID: ${t}`);switch(e){case"X":return 1===t?"2oYMBNV4eNHyqk2fjjV5nVQLDbtmNJzq5s3qs3Lo6ftnC6FByM":"2JVSBoinj9C2J33VntvzYtVJNZdN2NKiwwKjcumHUWEb5DbBrm";case ae:return 1===t?"2q9e4r6Mu3U68nU1fYjgbR6JvwrRx36CohpAX5UQxse55x1Q5":"yH8D7ThNJkxmtkuv2jgBa4P1Rn3Qpr4pPr7QYNfcdoS6k6HWp";case"P":return"11111111111111111111111111111111LpoYY";default:throw new Error(`Invalid chain alias: ${e}`)}}function le(t,n,r,s,i,a=0n){const o=function(t,n,r,s,i,a=0n,o){const c=e.evm.newImportTx(t,n,r,s,i,a,o);return a*e.utils.costCorethTx(c)}(t,n,r,s,i,a);let c=ce(o);return 0n===c&&(c=1n),e.evm.newImportTx(t,n,r,s,i,c)}exports.prepareExportTxn=async function(t,n){const r=n.context||await P(t),[s,i]=await Promise.all([m(t,{address:`0x${e.utils.strip0x(n.fromAddress)}`}),x(t)]),a=n.exportedOutput.addresses.map(e=>oe(e)),o=function(t,n,r,s,i,a,o){let c=ce(e.evm.estimateExportCost(t,n,r,s,i,a,o));return 0n===c&&(c=1n),e.evm.newExportTx(t,r,s,i,a,c,o)}(r,BigInt(i),n.exportedOutput.amount,ue(n.destinationChain,r.networkID),e.utils.hexToBuffer(n.fromAddress),a,BigInt(s));return{tx:o,exportTx:o.getTx(),chainAlias:"C"}},exports.prepareImportTxn=async function(t,n){const{account:r}=n,s=n.context||await P(t),i=await x(t),a=function(e,t){if(e)return e.map(e=>function(e,t){if(e)return e.startsWith(t)?e:`${t}-${1===e.split("-").length?e:e.split("-")[1]}`}(e,t)).filter(e=>void 0!==e)}(n.fromAddresses,ae)||[];if(0===a.length){const e=se(r),n=await async function(e,t,n,r){const s=se(t)?.xpAccount||e.xpAccount,i=se(t)?.evmAccount||e.account;if(!s||!i){const{xp:t,evm:s}=await async function(e){return e.request({method:"avalanche_getAccountPubKey",params:{}})}(e);return`${n}-${re(s,r)}`}if(!i.publicKey)throw new Error("EVM public key not found for evm account");return`${n}-${re(i.publicKey,r)}`}(t,e,ae,s.hrp);a.push(n)}const o=a.map(e=>oe(e));let c=n.utxos||[];c.length||(c=(await Promise.all(a.map(async e=>await async function(e,t){const n=t=>async function(e,t){return e.request({method:"avax.getUTXOs",params:t})}(e.cChainClient,t),r=[];let s,i=!1;do{const e=await n({addresses:[t.address],...t.sourceChain?{sourceChain:t.sourceChain}:{},...void 0===s?{}:{startIndex:s}});if(r.push(...e.utxos.map(e=>ie(e))),Number(e.numFetched)>=1024?(i=!0,s={address:e.endIndex.address,utxo:e.endIndex.utxo}):i=!1,r.length>=5e3)break}while(i);return r}(t,{address:e,sourceChain:ue(n.sourceChain,s.networkID)})))).flat());const u=le(s,e.utils.hexToBuffer(n.toAddress),o,c,ue(n.sourceChain,s.networkID),BigInt(i));return{tx:u,importTx:u.getTx(),chainAlias:ae}};
