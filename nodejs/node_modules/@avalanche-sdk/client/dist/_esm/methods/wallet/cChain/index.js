import{Id as e,utils as t,secp256k1 as n,Utxo as r,evm as s}from"@avalabs/avalanchejs";import{parseAbiItem as i}from"viem";function a(e){return function(e,{strict:t=!0}={}){return!!e&&"string"==typeof e&&(t?/^0x[0-9a-fA-F]*$/.test(e):e.startsWith("0x"))}(e,{strict:!1})?Math.ceil((e.length-2)/2):e.length}const o="2.38.6";let c=({docsBaseUrl:e,docsPath:t="",docsSlug:n})=>t?`${e??"https://viem.sh"}${t}${n?`#${n}`:""}`:void 0,u=`viem@${o}`;class d extends Error{constructor(e,t={}){const n=t.cause instanceof d?t.cause.details:t.cause?.message?t.cause.message:t.details,r=t.cause instanceof d&&t.cause.docsPath||t.docsPath,s=c?.({...t,docsPath:r});super([e||"An error occurred.","",...t.metaMessages?[...t.metaMessages,""]:[],...s?[`Docs: ${s}`]:[],...n?[`Details: ${n}`]:[],...u?[`Version: ${u}`]:[]].join("\n"),t.cause?{cause:t.cause}:void 0),Object.defineProperty(this,"details",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"docsPath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metaMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shortMessage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"BaseError"}),this.details=n,this.docsPath=r,this.metaMessages=t.metaMessages,this.name=t.name??this.name,this.shortMessage=e,this.version=o}walk(e){return l(this,e)}}function l(e,t){return t?.(e)?e:e&&"object"==typeof e&&"cause"in e&&void 0!==e.cause?l(e.cause,t):t?null:e}class f extends d{constructor({size:e,targetSize:t,type:n}){super(`${n.charAt(0).toUpperCase()}${n.slice(1).toLowerCase()} size (${e}) exceeds padding size (${t}).`,{name:"SizeExceedsPaddingSizeError"})}}function h(e,{dir:t,size:n=32}={}){return"string"==typeof e?function(e,{dir:t,size:n=32}={}){if(null===n)return e;const r=e.replace("0x","");if(r.length>2*n)throw new f({size:Math.ceil(r.length/2),targetSize:n,type:"hex"});return`0x${r["right"===t?"padEnd":"padStart"](2*n,"0")}`}(e,{dir:t,size:n}):function(e,{dir:t,size:n=32}={}){if(null===n)return e;if(e.length>n)throw new f({size:e.length,targetSize:n,type:"bytes"});const r=new Uint8Array(n);for(let s=0;s<n;s++){const i="right"===t;r[i?s:n-s-1]=e[i?s:e.length-s-1]}return r}(e,{dir:t,size:n})}class p extends d{constructor({max:e,min:t,signed:n,size:r,value:s}){super(`Number "${s}" is not in safe ${r?`${8*r}-bit ${n?"signed":"unsigned"} `:""}integer range ${e?`(${t} to ${e})`:`(above ${t})`}`,{name:"IntegerOutOfRangeError"})}}class g extends d{constructor({givenSize:e,maxSize:t}){super(`Size cannot exceed ${t} bytes. Given size: ${e} bytes.`,{name:"SizeOverflowError"})}}function m(e,{size:t}){if(a(e)>t)throw new g({givenSize:a(e),maxSize:t})}function x(e,t={}){return Number(function(e,t={}){const{signed:n}=t;t.size&&m(e,{size:t.size});const r=BigInt(e);if(!n)return r;const s=(e.length-2)/2;return r<=(1n<<8n*BigInt(s)-1n)-1n?r:r-BigInt(`0x${"f".padStart(2*s,"f")}`)-1n}(e,t))}function b(e,t={}){const{signed:n,size:r}=t,s=BigInt(e);let i;r?i=n?(1n<<8n*BigInt(r)-1n)-1n:2n**(8n*BigInt(r))-1n:"number"==typeof e&&(i=BigInt(Number.MAX_SAFE_INTEGER));const a="bigint"==typeof i&&n?-i-1n:0;if(i&&s>i||s<a){const t="bigint"==typeof e?"n":"";throw new p({max:i?`${i}${t}`:void 0,min:`${a}${t}`,signed:n,size:r,value:`${e}${t}`})}const o=`0x${(n&&s<0?(1n<<BigInt(8*r))+BigInt(s):s).toString(16)}`;return r?h(o,{size:r}):o}function y(e){return"string"==typeof e?{address:e,type:"json-rpc"}:e}async function w(e,{address:t,blockTag:n="latest",blockNumber:r}){return x(await e.request({method:"eth_getTransactionCount",params:[t,"bigint"==typeof r?b(r):n]},{dedupe:Boolean(r)}))}async function v(e){return e.request({method:"eth_baseFee",params:[]})}async function I(e,t){return e.request({method:"info.getBlockchainID",params:t})}i("event SendWarpMessage(address indexed sourceAddress, bytes32 indexed unsignedMessageID, bytes message)"),new e(new Uint8Array(32)),new e(new Uint8Array(32));const B=1,$=2,z=3,A=4,C=5,P=10,k=12345,S={[B]:"avax",[$]:"cascade",[z]:"denali",[A]:"everest",[C]:"fuji",[P]:"testing",[k]:"local"},D=e=>S[e]??"custom",E=async(e,t="AVAX")=>{const{assetID:n}=await async function(e,t){return e.request({method:"avm.getAssetDescription",params:t})}(e.xChainClient,{assetID:t}),{txFee:r,createAssetTxFee:s}=await async function(e){return e.request({method:"avm.getTxFee",params:{}})}(e.xChainClient),{blockchainID:i}=await I(e.infoClient,{alias:"X"}),{blockchainID:a}=await I(e.infoClient,{alias:"P"}),{blockchainID:o}=await I(e.infoClient,{alias:"C"}),{networkID:c}=await async function(e){return e.request({method:"info.getNetworkID",params:{}})}(e.infoClient),u=Number(c),d=await async function(e){const t=await e.request({method:"platform.getFeeConfig",params:{}});return{...t,maxCapacity:BigInt(t.maxCapacity),maxPerSecond:BigInt(t.maxPerSecond),minPrice:BigInt(t.minPrice),targetPerSecond:BigInt(t.targetPerSecond),excessConversionConstant:BigInt(t.excessConversionConstant)}}(e.pChainClient);return Object.freeze({xBlockchainID:i,pBlockchainID:a,cBlockchainID:o,avaxAssetID:n,baseTxFee:BigInt(r),createAssetTxFee:BigInt(s),networkID:u,hrp:D(u),platformFeeConfig:d})},T=2n**256n,N=T-0x1000003d1n,M=T-0x14551231950b75fc4402da1732fc9bebfn,j={a:0n,b:7n},q=e=>J(J(e*e)*e+j.b),O=(e="")=>{throw new Error(e)},U=e=>"bigint"==typeof e,F=e=>"string"==typeof e,V=e=>U(e)&&0n<e&&e<N,R=e=>U(e)&&0n<e&&e<M,H=e=>new Uint8Array(e),K=(e,t)=>((e,t)=>!(e instanceof Uint8Array)||"number"==typeof t&&t>0&&e.length!==t?O("Uint8Array expected"):e)(F(e)?G(e):H(e),t),J=(e,t=N)=>{let n=e%t;return n>=0n?n:t+n},Q=e=>e instanceof Y?e:O("Point expected");let X;class Y{constructor(e,t,n){this.px=e,this.py=t,this.pz=n}static fromAffine(e){return new Y(e.x,e.y,1n)}static fromHex(e){let t;const n=(e=K(e))[0],r=e.subarray(1),s=te(r,0,32),i=e.length;if(33===i&&[2,3].includes(n)){V(s)||O("Point hex invalid: x not FE");let e=se(q(s));!(1&~n)!==(1n==(1n&e))&&(e=J(-e)),t=new Y(s,e,1n)}return 65===i&&4===n&&(t=new Y(s,te(r,32,64),1n)),t?t.ok():O("Point is not on curve")}static fromPrivateKey(e){return W.mul(ie(e))}get x(){return this.aff().x}get y(){return this.aff().y}equals(e){const{px:t,py:n,pz:r}=this,{px:s,py:i,pz:a}=Q(e),o=J(t*a),c=J(s*r),u=J(n*a),d=J(i*r);return o===c&&u===d}negate(){return new Y(this.px,J(-this.py),this.pz)}double(){return this.add(this)}add(e){const{px:t,py:n,pz:r}=this,{px:s,py:i,pz:a}=Q(e),{a:o,b:c}=j;let u=0n,d=0n,l=0n;const f=J(3n*c);let h=J(t*s),p=J(n*i),g=J(r*a),m=J(t+n),x=J(s+i);m=J(m*x),x=J(h+p),m=J(m-x),x=J(t+r);let b=J(s+a);return x=J(x*b),b=J(h+g),x=J(x-b),b=J(n+r),u=J(i+a),b=J(b*u),u=J(p+g),b=J(b-u),l=J(o*x),u=J(f*g),l=J(u+l),u=J(p-l),l=J(p+l),d=J(u*l),p=J(h+h),p=J(p+h),g=J(o*g),x=J(f*x),p=J(p+g),g=J(h-g),g=J(o*g),x=J(x+g),h=J(p*x),d=J(d+h),h=J(b*x),u=J(m*u),u=J(u-h),h=J(m*p),l=J(b*l),l=J(l+h),new Y(u,d,l)}mul(e,t=!0){if(!t&&0n===e)return _;if(R(e)||O("invalid scalar"),this.equals(W))return ae(e).p;let n=_,r=W;for(let s=this;e>0n;s=s.double(),e>>=1n)1n&e?n=n.add(s):t&&(r=r.add(s));return n}mulAddQUns(e,t,n){return this.mul(t,!1).add(e.mul(n,!1)).ok()}toAffine(){const{px:e,py:t,pz:n}=this;if(this.equals(_))return{x:0n,y:0n};if(1n===n)return{x:e,y:t};const r=re(n);return 1n!==J(n*r)&&O("invalid inverse"),{x:J(e*r),y:J(t*r)}}assertValidity(){const{x:e,y:t}=this.aff();return V(e)&&V(t)||O("Point invalid: x or y"),J(t*t)===q(e)?this:O("Point invalid: not on curve")}multiply(e){return this.mul(e)}aff(){return this.toAffine()}ok(){return this.assertValidity()}toHex(e=!0){const{x:t,y:n}=this.aff();return(e?0n==(1n&n)?"02":"03":"04")+ne(t)+(e?"":ne(n))}toRawBytes(e=!0){return G(this.toHex(e))}}Y.BASE=new Y(0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798n,0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8n,1n),Y.ZERO=new Y(0n,1n,0n);const{BASE:W,ZERO:_}=Y,L=(e,t)=>e.toString(16).padStart(t,"0"),Z=e=>Array.from(e).map(e=>L(e,2)).join(""),G=e=>{const t=e.length;(!F(e)||t%2)&&O("hex invalid 1");const n=H(t/2);for(let t=0;t<n.length;t++){const r=2*t,s=e.slice(r,r+2),i=Number.parseInt(s,16);(Number.isNaN(i)||i<0)&&O("hex invalid 2"),n[t]=i}return n},ee=e=>BigInt("0x"+(Z(e)||"0")),te=(e,t,n)=>ee(e.slice(t,n)),ne=e=>Z((e=>U(e)&&e>=0n&&e<T?G(L(e,64)):O("bigint expected"))(e)),re=(e,t=N)=>{(0n===e||t<=0n)&&O("no inverse n="+e+" mod="+t);let n=J(e,t),r=t,s=0n,i=1n;for(;0n!==n;){const e=r%n,t=s-i*(r/n);r=n,n=e,s=i,i=t}return 1n===r?J(s,t):O("no inverse")},se=e=>{let t=1n;for(let n=e,r=(N+1n)/4n;r>0n;r>>=1n)1n&r&&(t=t*n%N),n=n*n%N;return J(t*t)===e?t:O("sqrt invalid")},ie=e=>(U(e)||(e=ee(K(e,32))),R(e)?e:O("private key out of range")),ae=e=>{const t=X||(X=(()=>{const e=[];let t=W,n=t;for(let r=0;r<33;r++){n=t,e.push(n);for(let r=1;r<128;r++)n=n.add(t),e.push(n);t=n.double()}return e})()),n=(e,t)=>{let n=t.negate();return e?n:t};let r=_,s=W;const i=BigInt(255),a=BigInt(8);for(let o=0;o<33;o++){const c=128*o;let u=Number(e&i);e>>=a,u>128&&(u-=256,e+=1n);const d=c,l=c+Math.abs(u)-1,f=o%2!=0,h=u<0;0===u?s=s.add(n(f,t[d])):r=r.add(n(h,t[l]))}return{p:r,f:s}};function oe(e,r){const s=Y.fromHex(t.strip0x(e)),i=new Uint8Array(s.toRawBytes(!0)),a=n.publicKeyBytesToAddress(i);return t.formatBech32(r,a)}function ce(e){return"string"==typeof e?{evmAccount:y(e)}:e}function ue(e,n){let s;s="string"==typeof e?t.hexToBuffer(e):e;return t.getManagerForVM("EVM").unpack(s,r)}const de="C";function le(e){return e.includes("-")?t.bech32ToBytes(e):t.bech32ToBytes(`P-${e}`)}function fe(e){return e/BigInt(1e9)}function he(e,t){if(1!==t&&5!==t)throw new Error(`Invalid network ID: ${t}`);switch(e){case"X":return 1===t?"2oYMBNV4eNHyqk2fjjV5nVQLDbtmNJzq5s3qs3Lo6ftnC6FByM":"2JVSBoinj9C2J33VntvzYtVJNZdN2NKiwwKjcumHUWEb5DbBrm";case de:return 1===t?"2q9e4r6Mu3U68nU1fYjgbR6JvwrRx36CohpAX5UQxse55x1Q5":"yH8D7ThNJkxmtkuv2jgBa4P1Rn3Qpr4pPr7QYNfcdoS6k6HWp";case"P":return"11111111111111111111111111111111LpoYY";default:throw new Error(`Invalid chain alias: ${e}`)}}function pe(e,n,r,i,a,o=0n){const c=function(e,n,r,i,a,o=0n,c){const u=s.newImportTx(e,n,r,i,a,o,c);return o*t.costCorethTx(u)}(e,n,r,i,a,o);let u=fe(c);return 0n===u&&(u=1n),s.newImportTx(e,n,r,i,a,u)}async function ge(e,n){const r=n.context||await E(e),[i,a]=await Promise.all([w(e,{address:`0x${t.strip0x(n.fromAddress)}`}),v(e)]),o=n.exportedOutput.addresses.map(e=>le(e)),c=function(e,t,n,r,i,a,o){let c=fe(s.estimateExportCost(e,t,n,r,i,a,o));return 0n===c&&(c=1n),s.newExportTx(e,n,r,i,a,c,o)}(r,BigInt(a),n.exportedOutput.amount,he(n.destinationChain,r.networkID),t.hexToBuffer(n.fromAddress),o,BigInt(i));return{tx:c,exportTx:c.getTx(),chainAlias:"C"}}async function me(e,n){const{account:r}=n,s=n.context||await E(e),i=await v(e),a=function(e,t){if(e)return e.map(e=>function(e,t){if(e)return e.startsWith(t)?e:`${t}-${1===e.split("-").length?e:e.split("-")[1]}`}(e,t)).filter(e=>void 0!==e)}(n.fromAddresses,de)||[];if(0===a.length){const t=ce(r),n=await async function(e,t,n,r){const s=ce(t)?.xpAccount||e.xpAccount,i=ce(t)?.evmAccount||e.account;if(!s||!i){const{xp:t,evm:s}=await async function(e){return e.request({method:"avalanche_getAccountPubKey",params:{}})}(e);return`${n}-${oe(s,r)}`}if(!i.publicKey)throw new Error("EVM public key not found for evm account");return`${n}-${oe(i.publicKey,r)}`}(e,t,de,s.hrp);a.push(n)}const o=a.map(e=>le(e));let c=n.utxos||[];c.length||(c=(await Promise.all(a.map(async t=>await async function(e,t){const n=t=>async function(e,t){return e.request({method:"avax.getUTXOs",params:t})}(e.cChainClient,t),r=[];let s,i=!1;do{const e=await n({addresses:[t.address],...t.sourceChain?{sourceChain:t.sourceChain}:{},...void 0===s?{}:{startIndex:s}});if(r.push(...e.utxos.map(e=>ue(e))),Number(e.numFetched)>=1024?(i=!0,s={address:e.endIndex.address,utxo:e.endIndex.utxo}):i=!1,r.length>=5e3)break}while(i);return r}(e,{address:t,sourceChain:he(n.sourceChain,s.networkID)})))).flat());const u=pe(s,t.hexToBuffer(n.toAddress),o,c,he(n.sourceChain,s.networkID),BigInt(i));return{tx:u,importTx:u.getTx(),chainAlias:de}}export{ge as prepareExportTxn,me as prepareImportTxn};
