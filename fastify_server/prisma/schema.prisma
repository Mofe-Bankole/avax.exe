// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  avatarUrl String?
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Socials
  socials Social[]

  // Friends
  sentFriends     Friend[] @relation("SentFriend")
  receivedFriends Friend[] @relation("ReceivedFriend")

  // Direct 1-1 chat
  directConversationsOne DirectConversation[] @relation("UserOneConversation")
  directConversationsTwo DirectConversation[] @relation("UserTwoConversation")
  directMessages         DirectMessage[]

  // Rooms
  roomMemberships RoomMember[]
  roomMessages    RoomMessage[]

  // Games
  games UserGame[]

  // Tournaments
  tournamentParticipants TournamentParticipant[]
}

//////////////////////////////////////////////////////
// SOCIALS
//////////////////////////////////////////////////////

model Social {
  id       String         @id @default(uuid())
  platform SocialPlatform
  url      String

  user   User   @relation(fields: [userId], references: [id])
  userId String

  @@unique([platform, userId])
}

enum SocialPlatform {
  X
  GOOGLE
  SPOTIFY
  LINKEDIN
  DISCORD
  GITHUB
}

//////////////////////////////////////////////////////
// FRIEND SYSTEM
//////////////////////////////////////////////////////

model Friend {
  id         String       @id @default(uuid())
  sender     User         @relation("SentFriend", fields: [senderId], references: [id])
  senderId   String
  receiver   User         @relation("ReceivedFriend", fields: [receiverId], references: [id])
  receiverId String
  status     FriendStatus @default(PENDING)
  createdAt  DateTime     @default(now())

  @@unique([senderId, receiverId])
}

enum FriendStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

//////////////////////////////////////////////////////
// DIRECT (WHATSAPP STYLE) CHAT
//////////////////////////////////////////////////////

model DirectConversation {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userOne   User   @relation("UserOneConversation", fields: [userOneId], references: [id])
  userOneId String

  userTwo   User   @relation("UserTwoConversation", fields: [userTwoId], references: [id])
  userTwoId String

  messages DirectMessage[]

  @@unique([userOneId, userTwoId])
}

model DirectMessage {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  edited    Boolean  @default(false)

  conversation   DirectConversation @relation(fields: [conversationId], references: [id])
  conversationId String

  sender   User   @relation(fields: [senderId], references: [id])
  senderId String

  @@index([conversationId])
}

//////////////////////////////////////////////////////
// DISCORD-STYLE CHAT ROOMS
//////////////////////////////////////////////////////

model ChatRoom {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        RoomType
  createdAt   DateTime @default(now())

  members  RoomMember[]
  messages RoomMessage[]
}

enum RoomType {
  PUBLIC
  PRIVATE
  TOURNAMENT
}

model RoomMember {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  room   ChatRoom @relation(fields: [roomId], references: [id])
  roomId String

  role RoomRole @default(MEMBER)

  @@unique([userId, roomId])
}

enum RoomRole {
  ADMIN
  MODERATOR
  MEMBER
}

model RoomMessage {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  edited    Boolean  @default(false)

  sender   User   @relation(fields: [senderId], references: [id])
  senderId String

  room   ChatRoom @relation(fields: [roomId], references: [id])
  roomId String

  @@index([roomId])
}

//////////////////////////////////////////////////////
// GAMES
//////////////////////////////////////////////////////

model Game {
  id          String    @id @default(uuid())
  title       String
  description String?
  studio      String?
  releaseDate DateTime?
  coverUrl    String?
  createdAt   DateTime  @default(now())

  owners      UserGame[]
  tags        GameTag[]
  tournaments Tournament[]
}

model UserGame {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  game   Game   @relation(fields: [gameId], references: [id])
  gameId String

  addedAt    DateTime @default(now())
  skillLevel Int?

  @@unique([userId, gameId])
}

model Tag {
  id    String  @id @default(uuid())
  name  String  @unique
  color String?

  games GameTag[]
}

model GameTag {
  id     String @id @default(uuid())
  game   Game   @relation(fields: [gameId], references: [id])
  gameId String

  tag   Tag    @relation(fields: [tagId], references: [id])
  tagId String

  @@unique([gameId, tagId])
}

//////////////////////////////////////////////////////
// TOURNAMENTS
//////////////////////////////////////////////////////

model Tournament {
  id          String   @id @default(uuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())

  game   Game   @relation(fields: [gameId], references: [id])
  gameId String

  participants TournamentParticipant[]
}

model TournamentParticipant {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  tournament   Tournament @relation(fields: [tournamentId], references: [id])
  tournamentId String

  @@unique([userId, tournamentId])
}
